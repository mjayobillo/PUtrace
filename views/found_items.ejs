<%- include('_header') %>

<div style="text-align:center;margin-bottom:1.5rem;">
  <h2 style="font-size:1.8rem;">üì¶ Found Items Board</h2>
  <p style="color:#888;max-width:550px;margin:0.5rem auto 0;">Found something on campus? Post it here so the owner can claim it. Looking for your lost item? Browse below!</p>
</div>

<!-- Post a Found Item -->
<section class="card">
  <details>
    <summary class="button btn-outline" style="width:100%;text-align:center;list-style:none;cursor:pointer;">
      ‚ûï I found an item ‚Äî post it here
    </summary>
    <form method="post" action="/found-items" enctype="multipart/form-data" style="margin-top:1.2rem;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <label>Your name <input name="finder_name" required placeholder="Your full name" value="<%= currentUser ? currentUser.full_name : '' %>" /></label>
        <label>Your email <input type="email" name="finder_email" required placeholder="you@email.com" value="<%= currentUser ? currentUser.email : '' %>" /></label>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <label>Item name <input name="item_name" required placeholder="e.g. Black Hydro Flask" /></label>
        <label>Category
          <select name="category">
            <% categories.forEach((cat) => { %>
              <option value="<%= cat %>"><%= cat %></option>
            <% }) %>
          </select>
        </label>
      </div>
      <label>Where did you find it? <input name="location_found" placeholder="e.g. Library 2nd floor, Room 301" /></label>
      <label>Description <textarea name="item_description" rows="3" placeholder="Describe the item ‚Äî color, brand, distinguishing marks..."></textarea></label>
      <label>Photo (optional) <input type="file" name="image" accept="image/*" /></label>
      <button type="submit" class="btn-success">Post Found Item</button>
    </form>
  </details>
</section>

<!-- Search & Filter -->
<section class="card">
  <form method="get" action="/found-items" class="search-filters">
    <div style="display:flex;gap:0.8rem;flex-wrap:wrap;align-items:flex-end;">
      <label style="flex:1;min-width:180px;">
        üîç Search
        <input type="text" name="search" value="<%= search %>" placeholder="Search found items..." />
      </label>
      <label style="min-width:140px;">
        Category
        <select name="category">
          <option value="">All</option>
          <% categories.forEach((cat) => { %>
            <option value="<%= cat %>" <%= filterCategory === cat ? 'selected' : '' %>><%= cat %></option>
          <% }) %>
        </select>
      </label>
      <button type="submit" class="btn-sm">Filter</button>
      <% if (search || filterCategory) { %>
        <a href="/found-items" class="button btn-sm btn-outline">Clear</a>
      <% } %>
    </div>
  </form>
</section>

<!-- Results -->
<% if (!posts || posts.length === 0) { %>
  <section class="card center-text" style="padding:3rem;">
    <div style="font-size:3rem;margin-bottom:0.5rem;">üì≠</div>
    <% if (search || filterCategory) { %>
      <h3>No items match your search</h3>
      <p style="color:#888;">Try different keywords or <a href="/found-items">clear filters</a></p>
    <% } else { %>
      <h3>No found items posted yet</h3>
      <p style="color:#888;">Found something on campus? Be the first to post it!</p>
    <% } %>
  </section>
<% } else { %>
  <p style="color:#888;margin-bottom:1rem;font-size:0.9rem;"><%= posts.length %> item<%= posts.length > 1 ? 's' : '' %> found and unclaimed</p>

  <div class="lost-grid">
    <% posts.forEach((post) => { %>
      <article class="lost-card">
        <div class="lost-card-header">
          <div>
            <h3><%= post.item_name %></h3>
            <% if (post.category && post.category !== 'Other') { %>
              <span class="badge badge-category"><%= post.category %></span>
            <% } %>
          </div>
          <span class="badge badge-active">Found</span>
        </div>
        <% if (post.image_url) { %>
          <div class="item-image-wrap">
            <img src="<%= post.image_url %>" alt="<%= post.item_name %>" class="item-image" />
          </div>
        <% } %>
        <p class="lost-card-desc"><%= post.item_description || 'No description provided' %></p>
        <div class="lost-card-meta">
          <span>Found by <strong><%= post.finder_name.split(' ')[0] %></strong></span>
          <% if (post.location_found) { %>
            <span>üìç <%= post.location_found %></span>
          <% } %>
          <span><%= new Date(post.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %></span>
        </div>
        <% if (currentUser) { %>
          <button type="button" class="btn-sm btn-success" style="width:100%;margin-top:0.8rem;" onclick="showClaimModal('<%= post.item_name.replace(/'/g, "\\'") %>', '<%= post.finder_name %>', '<%= post.finder_email %>', '<%= (post.location_found || '').replace(/'/g, "\\'") %>', <%= post.id %>)">üôã This is mine ‚Äî Claim it</button>
        <% } else { %>
          <p style="margin-top:0.8rem;font-size:0.85rem;color:#888;text-align:center;">
            <a href="/login">Login</a> to claim this item
          </p>
        <% } %>
      </article>
    <% }) %>
  </div>
<% } %>

<!-- Claim Modal Overlay -->
<div id="claimModal" class="modal-overlay" style="display:none;">
  <div class="modal-box">
    <button class="modal-close" onclick="closeClaimModal()">&times;</button>
    <div style="text-align:center;margin-bottom:1.2rem;">
      <div style="font-size:2.5rem;">üéâ</div>
      <h2 style="margin-top:0.5rem;" id="modalTitle">Item Claimed!</h2>
    </div>
    <p style="color:#555;text-align:center;margin-bottom:1.5rem;">Contact the finder to arrange pickup:</p>
    <div class="modal-info">
      <div class="modal-info-row">
        <span class="modal-label">üë§ Finder</span>
        <span id="modalFinderName" class="modal-value"></span>
      </div>
      <div class="modal-info-row">
        <span class="modal-label">üìß Email</span>
        <a id="modalFinderEmail" href="" class="modal-value" style="color:#3a56e4;"></a>
      </div>
      <div class="modal-info-row" id="modalLocationRow" style="display:none;">
        <span class="modal-label">üìç Found at</span>
        <span id="modalLocation" class="modal-value"></span>
      </div>
    </div>
    <form id="claimForm" method="post" action="" style="margin-top:1.5rem;">
      <button type="submit" class="btn-success" style="width:100;">‚úÖ Confirm Claim</button>
    </form>
    <button type="button" onclick="closeClaimModal()" class="button btn-outline" style="width:100%;margin-top:0.5rem;">Cancel</button>
  </div>
</div>

<script>
  function showClaimModal(itemName, finderName, finderEmail, location, postId) {
    document.getElementById('modalTitle').textContent = 'Claim "' + itemName + '"';
    document.getElementById('modalFinderName').textContent = finderName;
    document.getElementById('modalFinderEmail').textContent = finderEmail;
    document.getElementById('modalFinderEmail').href = 'mailto:' + finderEmail;
    document.getElementById('claimForm').action = '/found-items/' + postId + '/claim';
    if (location) {
      document.getElementById('modalLocation').textContent = location;
      document.getElementById('modalLocationRow').style.display = 'flex';
    } else {
      document.getElementById('modalLocationRow').style.display = 'none';
    }
    document.getElementById('claimModal').style.display = 'flex';
  }
  function closeClaimModal() {
    document.getElementById('claimModal').style.display = 'none';
  }
  document.getElementById('claimModal').addEventListener('click', function(e) {
    if (e.target === this) closeClaimModal();
  });
</script>

<%- include('_footer') %>
