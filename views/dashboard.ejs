<%- include('_header') %>

<%
  const firstName = currentUser.full_name.split(' ')[0];
  const openReportsCount = reports.filter((r) => r.status === 'open').length;
  const resolvedReportsCount = reports.filter((r) => r.status === 'resolved').length;
%>

<div class="dashboard-top">
  <h2 class="dashboard-title">Welcome, <%= firstName %></h2>
  <div class="dashboard-quick-links">
    <a href="/lost" class="button btn-outline">Lost Board</a>
    <a href="/found-items" class="button btn-outline">Found Board</a>
  </div>
</div>

<div class="stats-bar">
  <div class="stat-card">
    <div class="stat-number"><%= items.length %></div>
    <div class="stat-label">Items</div>
  </div>
  <div class="stat-card">
    <div class="stat-number"><%= openReportsCount %></div>
    <div class="stat-label">Open Reports</div>
  </div>
  <div class="stat-card">
    <div class="stat-number"><%= resolvedReportsCount %></div>
    <div class="stat-label">Resolved</div>
  </div>
</div>

<section class="card">
  <div class="section-head">
    <h2 class="section-title">Your Items</h2>
    <a href="/items/new" class="button btn-sm">Register New Item</a>
  </div>

  <form method="get" action="/dashboard" class="search-filters">
    <div class="row-filters">
      <label class="filter-search">
        Search
        <input type="text" name="search" value="<%= search %>" placeholder="Search items..." />
      </label>
      <label class="filter-category">
        Category
        <select name="category">
          <option value="">All</option>
          <% categories.forEach((cat) => { %>
            <option value="<%= cat %>" <%= filterCategory === cat ? 'selected' : '' %>><%= cat %></option>
          <% }) %>
        </select>
      </label>
      <label class="filter-status">
        Status
        <select name="status">
          <option value="">All</option>
          <option value="active" <%= filterStatus === 'active' ? 'selected' : '' %>>Active</option>
          <option value="lost" <%= filterStatus === 'lost' ? 'selected' : '' %>>Lost</option>
          <option value="recovered" <%= filterStatus === 'recovered' ? 'selected' : '' %>>Recovered</option>
        </select>
      </label>
      <button type="submit" class="btn-sm">Filter</button>
      <% if (search || filterCategory || filterStatus) { %>
        <a href="/dashboard" class="button btn-sm btn-outline">Clear</a>
      <% } %>
    </div>
  </form>

  <% if (!items || items.length === 0) { %>
    <div class="center-text empty-state">
      <div class="empty-icon">...</div>
      <% if (search || filterCategory || filterStatus) { %>
        <p>No items match your filters. <a href="/dashboard">Clear filters</a></p>
      <% } else { %>
        <p>No items registered yet. Use "Register New Item" to add your first one.</p>
      <% } %>
    </div>
  <% } else { %>
    <div class="item-grid">
      <% items.forEach((item) => { %>
        <%- include('_dashboard_item_card', { item, baseUrl }) %>
      <% }) %>
    </div>
  <% } %>
</section>

<section class="card">
  <h2>Finder Reports</h2>
  <% if (!reports || reports.length === 0) { %>
    <div class="center-text empty-state">
      <div class="empty-icon">...</div>
      <p>No reports yet. When someone scans your QR code, their report will appear here.</p>
    </div>
  <% } else { %>
    <table>
      <thead>
        <tr><th>Item</th><th>Finder</th><th>Message</th><th>Status</th><th class="action-col-min">Action</th></tr>
      </thead>
      <tbody>
      <% reports.forEach((r) => { %>
        <%- include('_dashboard_report_row', { r }) %>
      <% }) %>
      </tbody>
    </table>
  <% } %>
</section>
<%- include('_footer') %>
